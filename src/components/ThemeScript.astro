<script is:inline>
  (() => {
    const STORAGE_KEY = "theme-preference";

    const getStorage = () => {
      try {
        return window.localStorage;
      } catch {
        return null;
      }
    };

    const readStoredTheme = () => {
      const storage = getStorage();
      if (!storage) return null;
      try {
        return storage.getItem(STORAGE_KEY);
      } catch {
        return null;
      }
    };

    const writeStoredTheme = (value) => {
      const storage = getStorage();
      if (!storage) return;
      try {
        storage.setItem(STORAGE_KEY, value);
      } catch {
        /* noop */
      }
    };

    const applyTheme = (mode) => {
      const root = document.documentElement;
      const theme = mode === "dark" ? "dark" : "light";
      root.dataset.theme = theme;
      root.style.colorScheme = theme;
      return theme;
    };

    if (window.__themeControllerInitialized) {
      return;
    }
    window.__themeControllerInitialized = true;

    const prefersDark = window.matchMedia
      ? window.matchMedia("(prefers-color-scheme: dark)")
      : null;

    const resolveCurrentTheme = () =>
      readStoredTheme() ??
      document.documentElement.dataset.theme ??
      (prefersDark?.matches ? "dark" : "light");

    const savedTheme = readStoredTheme();
    const initialTheme =
      savedTheme ?? (prefersDark?.matches ? "dark" : "light");
    applyTheme(initialTheme);

    const setTheme = (value, { persist = true } = {}) => {
      const nextTheme = applyTheme(value);
      if (persist) {
        writeStoredTheme(nextTheme);
      }
      window.dispatchEvent(
        new CustomEvent("themechange", { detail: nextTheme }),
      );
      return nextTheme;
    };

    window.__theme = {
      get: () => document.documentElement.dataset.theme ?? "light",
      set: (value) => setTheme(value),
      toggle: () => {
        const next =
          document.documentElement.dataset.theme === "dark" ? "light" : "dark";
        return setTheme(next);
      },
    };

    if (prefersDark) {
      const handlePrefersChange = (event) => {
        if (readStoredTheme()) {
          return;
        }
        const theme = event.matches ? "dark" : "light";
        setTheme(theme, { persist: false });
      };

      if (typeof prefersDark.addEventListener === "function") {
        prefersDark.addEventListener("change", handlePrefersChange);
      } else if (typeof prefersDark.addListener === "function") {
        prefersDark.addListener(handlePrefersChange);
      }
    }

    const reapplyTheme = () => {
      applyTheme(resolveCurrentTheme());
    };

    document.addEventListener("astro:page-load", reapplyTheme);
    window.addEventListener("pageshow", reapplyTheme);

    window.dispatchEvent(
      new CustomEvent("themecontrollerready", { detail: initialTheme }),
    );
  })();
</script>
